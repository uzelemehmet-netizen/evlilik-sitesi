name: Matchmaking Cron

on:
  schedule:
    # GitHub Actions schedule minimum ~5 minutes (best-effort).
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Call matchmaking cron endpoint
        shell: bash
        env:
          CRON_URL: ${{ secrets.MATCHMAKING_CRON_URL }}
          CRON_SECRET: ${{ secrets.MATCHMAKING_CRON_SECRET }}
        run: |
          set -euo pipefail

          if [[ -z "${CRON_URL}" ]]; then
            echo "Missing secret: MATCHMAKING_CRON_URL" >&2
            exit 1
          fi
          if [[ -z "${CRON_SECRET}" ]]; then
            echo "Missing secret: MATCHMAKING_CRON_SECRET" >&2
            exit 1
          fi

          echo "Calling: ${CRON_URL}"
          resp_file="response.json"

            status=$(curl -sS -L \
            --retry 3 --retry-delay 5 \
            -X POST \
            -H "content-type: application/json" \
            -H "x-cron-secret: ${CRON_SECRET}" \
            -H "accept: application/json" \
            -d '{}' \
            -o "${resp_file}" \
            -w "%{http_code}" \
            "${CRON_URL}")

            echo "HTTP status: ${status}"
            echo "Response:"; cat "${resp_file}"; echo

            if [[ "${status}" != "200" ]]; then
            echo "Non-200 response" >&2
            exit 1
            fi

            python -c "import json; data=json.load(open('response.json','r',encoding='utf-8')); assert data.get('ok') is True, data; print('ok=true')"
