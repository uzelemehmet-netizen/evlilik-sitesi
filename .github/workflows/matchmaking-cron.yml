name: Matchmaking Cron

on:
  schedule:
    # GitHub Actions schedule minimum ~5 minutes (best-effort).
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Call matchmaking cron endpoint
        shell: bash
        env:
          CRON_URL: ${{ secrets.MATCHMAKING_CRON_URL }}
          CRON_SECRET: ${{ secrets.MATCHMAKING_CRON_SECRET }}
        run: |
          set -euo pipefail

          if [[ -z "${CRON_URL}" ]]; then
            echo "Missing secret: MATCHMAKING_CRON_URL" >&2
            exit 1
          fi
          if [[ -z "${CRON_SECRET}" ]]; then
            echo "Missing secret: MATCHMAKING_CRON_SECRET" >&2
            exit 1
          fi

          echo "Calling: ${CRON_URL}"
          resp_file="response.json"

          status_file="status.txt"

          curl -sS -L \
            --retry 3 --retry-delay 5 \
            -X POST \
            -H "content-type: application/json" \
            -H "x-cron-secret: ${CRON_SECRET}" \
            -H "accept: application/json" \
            -d '{}' \
            -w "%{http_code}" \
            "${CRON_URL}" \
            -o "${resp_file}" > "${status_file}"

          echo "HTTP status: $(cat "${status_file}")"

          echo "Response:"; cat "${resp_file}"; echo

            python - <<'PY'
          import json
            import sys

          with open('response.json', 'r', encoding='utf-8') as f:
              raw = f.read().strip()

            with open('status.txt', 'r', encoding='utf-8') as f:
              status = f.read().strip()

            if status and status != '200':
              raise SystemExit(f"HTTP status {status}. Response (first 300 chars): {raw[:300]!r}")

          try:
              data = json.loads(raw)
          except Exception as e:
              raise SystemExit(
                  f"Response is not JSON. First 200 chars: {raw[:200]!r}. Error: {e}"
              )

          if data.get('ok') is not True:
              raise SystemExit(f"ok!=true. Response: {data}")

          print('ok=true')
          PY
